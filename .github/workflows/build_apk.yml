name: Build Web2APK with Progress

on:
  repository_dispatch:
    types: [build_apk]

jobs:
  build:
    runs-on: ubuntu-latest

    # Set variable environment biar command curl lebih pendek
    env:
      BOT_TOKEN: 7917636689:AAGWDCVzyYE70Fp0ii2j8LyZZGeqaB5qNko
      CHAT_ID: ${{ github.event.client_payload.chat_id }}
      MSG_ID: ${{ github.event.client_payload.message_id }}

    steps:
      # --- UPDATE STATUS 20% ---
      - name: Update Status - Setup
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/editMessageText \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID \
          -d parse_mode="Markdown" \
          -d text="‚öôÔ∏è **[20%]** Menyiapkan Environment (Java & Node.js)..."

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # --- UPDATE STATUS 50% ---
      - name: Update Status - Installing
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/editMessageText \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID \
          -d parse_mode="Markdown" \
          -d text="üì¶ **[50%]** Menginstall Cordova & Dependencies..."

      - name: Install Cordova
        run: npm install -g cordova

      # --- UPDATE STATUS 75% ---
      - name: Update Status - Building
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/editMessageText \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID \
          -d parse_mode="Markdown" \
          -d text="üî® **[75%]** Sedang Compile APK (Mohon tunggu)..."

      - name: Create Project & Build
        run: |
          cordova create MyApp com.zar.web2apk ZarApp
          cd MyApp
          cordova platform add android
          sed -i 's|src="index.html"|src="${{ github.event.client_payload.target_url }}"|g' config.xml
          cordova build android --release -- --packageType=apk

      # --- UPDATE STATUS 90% ---
      - name: Update Status - Uploading
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/editMessageText \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID \
          -d parse_mode="Markdown" \
          -d text="cloud_upload **[99%]** Mengupload file ke Telegram..."

      - name: Send APK to Telegram
        run: |
          APK_PATH="MyApp/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          
          # Kirim File APK (sebagai pesan baru)
          curl -v -F "chat_id=$CHAT_ID" -F document=@$APK_PATH \
          -F caption="‚úÖ **Selesai!** Aplikasi untuk ${{ github.event.client_payload.target_url }}" \
          https://api.telegram.org/bot$BOT_TOKEN/sendDocument
          
          # Hapus pesan status progress (opsional, atau edit jadi "Selesai")
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/deleteMessage \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID

      # --- JIKA GAGAL ---
      - name: Notify Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/editMessageText \
          -d chat_id=$CHAT_ID -d message_id=$MSG_ID \
          -d text="‚ùå **Build Gagal!** Ada masalah di server GitHub."
