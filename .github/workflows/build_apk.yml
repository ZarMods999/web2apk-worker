name: Build Web2APK

on:
  repository_dispatch:
    types: [build_apk]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Cordova
        run: npm install -g cordova

      - name: Create Project & Build
        run: |
          # 1. Buat Project Baru
          cordova create MyApp com.zar.web2apk ZarApp
          cd MyApp
          cordova platform add android
          
          # 2. Inject URL dari Payload Bot ke config.xml
          # Kita ganti src="index.html" dengan URL user
          sed -i 's|src="index.html"|src="${{ github.event.client_payload.target_url }}"|g' config.xml
          
          # Opsional: Bisa ganti nama aplikasi juga disini jika mau
          
          # 3. Build APK
          cordova build android --release -- --packageType=apk

      - name: Send APK to Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ github.event.client_payload.chat_id }}
        run: |
          # Cari file APK
          APK_PATH="MyApp/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          
          # Kirim pesan "Uploading..."
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage -d chat_id=$CHAT_ID -d text="ðŸ”¨ Build selesai! Sedang mengupload..."
          
          # Kirim Dokumen APK
          curl -v -F "chat_id=$CHAT_ID" -F document=@$APK_PATH https://api.telegram.org/bot$BOT_TOKEN/sendDocument
